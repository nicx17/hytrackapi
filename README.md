# HyTrack API v2.0.0

A secure, high-performance REST API built with **FastAPI** to actively scrape and track shipment statuses for **Blue Dart** and **Delhivery**. 

This application serves as an independent microservice that replaces unreliable public APIs or manual checking by automating web scraping intelligently. It includes robust local API key management, rate-limiting, and hardened bcrypt hashing for administrative scale.

## üöÄ Features

- **Multi-Courier Support:** Get unified, real-time shipment status JSON responses for both Blue Dart and Delhivery.
- **Headless Browser Scraping:** Bypasses complex JS-rendered tracking sites (Delhivery) automatically using headless Selenium workflows via `webdriver-manager`.
- **Admin Key Management:** Generate and revoke individual API Client Keys for separate apps or users, backed by SQLite.
- **Hardened Security:** 
  - All tracking keys are securely hashed using **bcrypt** (`passlib`).
  - Active **Rate Limiting** (`slowapi`) is enforced at 10 requests/minute to prevent Denial of Service sweeps.
  - Strict separation of duties between the `.env` Master Key and generated Client Keys.

---

## üõ†Ô∏è Quick Start & Setup

Ensure you have **Python 3.9+** installed. The system requires Google Chrome (or Chromium) locally to execute the headless Selenium scraping instances.

### 1. Install Dependencies
Set up your virtual environment and install the required packages:
```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

### 2. Configure Environment Variables
You must define a Master `API_KEY`. This key will be used strictly to generate and manage your client tracking keys.
```bash
echo 'API_KEY="your_super_secret_master_key_here"' > .env
```

### 3. Start the Server
You can launch the server using the provided shell script or directly via uvicorn:
```bash
./run.sh
# Alternatively: uvicorn api:app --host 127.0.0.1 --port 8000
```

---

## üîë Authentication & API Key Management

The API uses a two-tier authentication system.
1. **Master Key**: Defined securely in `.env`. Used *only* for the `/admin/*` endpoints.
2. **Client Keys**: Generated by the API. Used for the `/track` endpoint.

### Generate a Client Key
Include the Master Key in the `X-API-Key` header to request a new client token:
```bash
curl -X POST -H 'X-API-Key: your_super_secret_master_key_here' \
    "http://127.0.0.1:8000/admin/keys/generate?name=Mobile_App_Client"
```
*Note: The generated plaintext key will only be shown once! The API securely stores a `bcrypt` hash in the `api_keys.db` SQLite database.*

---

## üì¶ Utilizing the Tracker API

**Endpoint**: `GET /track`  
**Headers Required**: `X-API-Key: <your_generated_client_key>`  
**Query Parameters**: 
- `courier`: `BLUEDART` or `DELHIVERY`
- `waybill`: The tracking number

### Example Request (BlueDart)
```bash
curl -s -H "X-API-Key: 1.BpccXmw_secureClientKeyString" \
    "http://127.0.0.1:8000/track?courier=BLUEDART&waybill=76805715232"
```

### Example Response
```json
{
  "Courier": "Blue Dart",
  "Location": "Quepem",
  "Details": "Shipment Delivered",
  "Date": "2026-01-27",
  "Time": "15:56",
  "Link": "https://www.bluedart.com/trackdartresultthirdparty?trackFor=0&trackNo=76805715232"
}
```

### Rate Limiting
To protect system resources, primarily the overhead of spawning headless browsers, the `/track` endpoint limits individual IP addresses to **10 requests per minute**. Exceeding this triggers a `429 Too Many Requests` error.

---

## üìò Interactive Docs (Swagger UI)
Because the system is powered by FastAPI, an interactive documentation playground is generated automatically. 
While the server is running, navigate your web browser to:
`http://127.0.0.1:8000/docs`

You can authenticate using the UI and execute test queries against the endpoint directly.

---

## üèóÔ∏è Bare-Metal Deployment (Raspberry Pi / Linux)

For a persistent, robust deployment, we recommend using `systemd` to keep the API running as a background service, combined with `nginx` as a reverse proxy. 

Templates have been provided in the root directory:
- `hytrack.service`: Systemd service definition.
- `hytrack.nginx`: Nginx server block configuration.

### Deployment Steps
1. **Ensure Nginx is installed**: `sudo apt install nginx`
2. **Move Systemd Service**: Complete the paths inside `hytrack.service` and copy it to your system utilities.
   ```bash
   sudo cp hytrack.service /etc/systemd/system/
   sudo systemctl daemon-reload
   sudo systemctl enable --now hytrack.service
   ```
3. **Move Nginx Proxy**: Copy the Nginx config, create a symlink in `sites-enabled`, and restart Nginx.
   ```bash
   sudo cp hytrack.nginx /etc/nginx/sites-available/hytrack
   sudo ln -s /etc/nginx/sites-available/hytrack /etc/nginx/sites-enabled/
   sudo systemctl restart nginx
   ```
   *Note: Using Nginx ensures that client IPs are passed correctly to the rate-limiter via the `X-Real-IP` and `X-Forwarded-For` headers.*
