# HyTrack API v2.0.0

A secure, high-performance REST API built with FastAPI to actively scrape and track shipment statuses for Blue Dart and Delhivery. 

This application serves as an independent microservice that replaces unreliable public APIs or manual checking by automating web scraping intelligently. It includes robust local API key management, rate-limiting, and hardened bcrypt hashing for administrative scale and security.

## Features

- Multi-Courier Support: Get unified, real-time shipment status JSON responses for both Blue Dart and Delhivery.
- Headless Browser Scraping: Bypasses complex JS-rendered tracking sites (Delhivery) automatically using headless Selenium workflows via `webdriver-manager`.
- Admin Key Management: Generate and revoke individual API Client Keys for separate apps or users, backed by SQLite.
- Hardened Security Architecture: 
  - All tracking keys are securely hashed using native `bcrypt` military-grade hashing.
  - Active Rate Limiting (`slowapi`) is enforced at 10 requests/minute to prevent Denial of Service sweeps.
  - Anti-Timing Attack measures applied to the Master Key verification.
  - Global Asynchronous Semaphore limits concurrent headless Chrome browsers to prevent RAM exhaustion (OOM crashes) under heavy load.
  - Strict separation of duties between the `.env` Master Key and generated Client Keys.
  - Parameter injection protection enforcing strict alphanumeric bounds on waybills.

---

## Quick Start & Setup

Ensure you have Python 3.9+ installed. The system requires Google Chrome (or Chromium) locally to execute the headless Selenium scraping instances.

### 1. Install Dependencies
Set up your virtual environment and install the required packages:
```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

### 2. Configure Environment Variables
You must define a Master `API_KEY`. This key will be used strictly to generate and manage your client tracking keys.
```bash
echo 'API_KEY="your_super_secret_master_key_here"' > .env
```

### 3. Start the Server
You can launch the server using the provided shell script or directly via uvicorn:
```bash
./run.sh
# Alternatively: uvicorn api:app --host 127.0.0.1 --port 8000
```

---

## Authentication & API Key Management

The API uses a two-tier authentication system.
1. Master Key: Defined securely in `.env`. Used *only* for the `/admin/*` endpoints.
2. Client Keys: Generated by the API. Used for the `/track` endpoint.

**Public API Access:** The official API is currently hosted at `https://assa.hyclotron.com`. To obtain an active Client API Key for this endpoint, please contact `nick@hyclotron.com` or submit a pull request detailing your integration use case.

### Generate a Client Key
Include the Master Key in the `X-API-Key` header to request a new client token:
```bash
curl -X POST -H 'X-API-Key: your_super_secret_master_key_here' \
    "http://127.0.0.1:8000/admin/keys/generate?name=Mobile_App_Client"
```
*Note: The generated plaintext key will only be shown once! The API securely stores a `bcrypt` hash in the `api_keys.db` SQLite database.*

---

## Utilizing the Tracker API

**Endpoint**: `GET /track`  
**Headers Required**: `X-API-Key: <your_generated_client_key>`  
**Query Parameters**: 
- `courier`: `BLUEDART` or `DELHIVERY`
- `waybill`: The tracking number (Alphanumeric only, max 50 characters)

### Example Request (BlueDart)
```bash
curl -s -H "X-API-Key: 1.BpccXmw_secureClientKeyString" \
    "https://assa.hyclotron.com/track?courier=BLUEDART&waybill=76805715232"
```

### Example Response
```json
{
  "Courier": "Blue Dart",
  "Location": "Quepem",
  "Details": "Shipment Delivered",
  "Date": "2026-01-27",
  "Time": "15:56",
  "Link": "https://www.bluedart.com/trackdartresultthirdparty?trackFor=0&trackNo=76805715232"
}
```

### Rate Limiting
To protect system resources, primarily the overhead of spawning headless browsers, the `/track` endpoint limits individual IP addresses to 10 requests per minute. Exceeding this triggers a `429 Too Many Requests` error.

---

## Interactive Docs (Swagger UI)
Because the system is powered by FastAPI, an interactive documentation playground is generated automatically. 
While the server is running, navigate your web browser to:
`https://assa.hyclotron.com/docs` (if exposed publicly) or `http://127.0.0.1:8000/docs` locally.

You can authenticate using the UI and execute test queries against the endpoint directly. 
*Note for Production: It is highly advised to place a WAF rule blocking public access to `/docs` to prevent exposure of your API layout.*

---

## Bare-Metal Deployment (Raspberry Pi / Linux)

For a persistent, robust deployment, we recommend using `systemd` to keep the API running as a background service, combined with `nginx` as a reverse proxy. 

Templates have been provided in the root directory:
- `hytrack.service`: Systemd service definition.
- `hytrack.nginx`: Nginx server block configuration.

### Deployment Steps
1. **Ensure Nginx is installed**: `sudo apt install nginx`
2. **Move Systemd Service**: Complete the paths inside `hytrack.service` to point to your `uvicorn` binary within the `.venv` and copy it to your system utilities.
   ```bash
   sudo cp hytrack.service /etc/systemd/system/
   sudo systemctl daemon-reload
   sudo systemctl enable --now hytrack.service
   ```
3. **Move Nginx Proxy**: Copy the Nginx config, create a symlink in `sites-enabled`, and restart Nginx.
   ```bash
   sudo cp hytrack.nginx /etc/nginx/sites-available/hytrack
   sudo ln -s /etc/nginx/sites-available/hytrack /etc/nginx/sites-enabled/
   sudo systemctl restart nginx
   ```
   *Note: Using Nginx ensures that client IPs are passed correctly to the rate-limiter via the `X-Real-IP` and `X-Forwarded-For` headers. For optimal host binding on a LAN, bind uvicorn to `0.0.0.0` in your systemd command.*
